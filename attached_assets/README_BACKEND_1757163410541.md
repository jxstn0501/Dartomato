# DartsMind â€” Minimal Test Backend (FastAPI + SQLite)

This tiny backend lets you **upload DartsMind screenshots (JPEG/PNG)**, sends them to **ParseExtract**,
stores the **raw response** and a **normalized placeholder** in SQLite, and exposes a few endpoints to inspect results.

> Goal: quickly validate that ParseExtract returns the text/data you expect, before building the full pipeline.

## Features
- `POST /upload` â€” upload one image; forwards to ParseExtract (configurable URL & key), persists raw + normalized.
- `GET /ingests` â€” list recent uploads.
- `GET /ingests/{id}` â€” fetch one upload incl. raw & normalized payloads.
- `GET /health` â€” quick health check.
- Minimal "normalizer" that wraps raw data into a **multiplayer schema** (up to 7 players) and a **bust** flag.
  - Real parsing depends on your exact DartsMind layout; plug your own mapping in `app/normalizer.py` later.

## Quick start

1) **Create a virtualenv (optional but recommended)**

```bash
python3 -m venv .venv && source .venv/bin/activate
```

2) **Install deps**

```bash
pip install -r requirements.txt
```

3) **Configure environment**

Copy `.env.example` to `.env` and set your **ParseExtract** credentials:

```bash
cp .env.example .env
# then edit .env to set PARSEXTRACT_API_KEY and PARSEXTRACT_URL
```

4) **Run**

```bash
bash run.sh
# or
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

5) **Test**

Use the included `requests.http` file (REST Client), or `curl`:

```bash
curl -X POST "http://localhost:8000/upload"   -F "player_names=Alice,Bob"   -F "image=@/path/to/row-1-column-1.jpeg"
```

Open docs at http://localhost:8000/docs

## Endpoints (summary)

- `GET /health` â†’ `{"status":"ok"}`
- `POST /upload` (multipart form):
  - fields:
    - `image` (file)
    - `player_names` (comma-separated, up to 7 names; optional)
    - `bust` (`true`/`false`; optional; defaults to false)
    - `meta` (JSON string, optional)
- `GET /ingests` â†’ list of recent ingests
- `GET /ingests/{id}` â†’ one item with raw and normalized payload
- `DELETE /ingests/{id}` â†’ delete

## Notes

- This project intentionally keeps the **normalizer** simple. It wraps the raw ParseExtract result into a
  multiplayer-aware schema so you can focus on validating OCR accuracy first.
- To customize parsing, edit `app/normalizer.py` and replace `infer_visits_from_text()` with your own mapping rules.
- If `PARSEXTRACT_URL` is missing or unreachable, the backend raises a clear error. You can temporarily **stub** a response
  by setting the env var `PARSEXTRACT_STUB=1` â€” this will skip the network call and return a demo payload.

## Data model

SQLite DB file: `data.db` (auto-created). Table: `ingests`

Columns: `id`, `created_at`, `filename`, `player_names`, `bust`, `meta_json`, `raw_json`, `normalized_json`

---

Made to be copy-paste friendly and tiny. Extend as you like ðŸ’™
